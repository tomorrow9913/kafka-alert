name: Bandit Security Scan
on:
  push:
    branches:
      - master
      - main
  pull_request:
    types:
      - opened
      - synchronize
      - ready_for_review
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        if: github.event_name != 'workflow_dispatch'
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
             **.py

      - name: Set up Python
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      # [1] ì„¤ì¹˜: banditê³¼ í¬ë§·í„°ë¥¼ 'í•¨ê»˜' ì„¤ì¹˜í•©ë‹ˆë‹¤.
      # í¬ë§·í„°ë¥¼ ì„¤ì¹˜í•˜ë©´ Banditì´ í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ ìë™ ì¸ì‹í•©ë‹ˆë‹¤.
      - name: Install bandit and sarif formatter
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          python -m pip install --upgrade pip
          pip install bandit bandit-sarif-formatter

      # [2] ì‹¤í–‰: --format sarif ì˜µì…˜ì„ ì§ì ‘ ì‚¬ìš©í•©ë‹ˆë‹¤.
      - name: Run Bandit scan
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          # (A) ë¡œì§ ì²´í¬ìš© JSON ìƒì„± (High ë“±ê¸‰ ê°œìˆ˜ íŒŒì•…ì„ ìœ„í•´ í•„ìš”)
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "Scanning ALL files for Metrics..."
             bandit -r . -f json -o bandit-results.json || true
          else
             echo "Scanning CHANGED files for Metrics..."
             bandit -f json -o bandit-results.json $ALL_CHANGED_FILES || true
          fi

          # (B) GitHub ì—…ë¡œë“œìš© SARIF ìƒì„± (ì‚¬ìš©ìë‹˜ì´ ì°¾ìœ¼ì‹  ì •ì„ ë°©ë²•)
          # í”ŒëŸ¬ê·¸ì¸ì´ ì„¤ì¹˜ë˜ì—ˆìœ¼ë¯€ë¡œ --format sarif ì‚¬ìš© ê°€ëŠ¥
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "Generating SARIF for ALL files..."
             bandit -r . --format sarif --output bandit-results.sarif || true
          else
             echo "Generating SARIF for CHANGED files..."
             bandit --format sarif --output bandit-results.sarif $ALL_CHANGED_FILES || true
          fi

      - name: Upload SARIF file
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: bandit-results.sarif
          category: bandit

      - name: Check for High Severity Issues
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          HIGH_ISSUES=$(jq '.metrics._totals."SEVERITY.HIGH"' bandit-results.json)

          echo "Detected High Severity Issues: $HIGH_ISSUES"

          if [ "$HIGH_ISSUES" != "null" ] && [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "::error::ğŸš¨ High severity security issues found! Blocking merge."
            exit 1
          else
            echo "âœ… No High severity issues found."
          fi
